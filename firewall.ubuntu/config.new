config version 2.01
#hardware autodetect
clock timezone PDT
clock server time.vortech.net
password admin $1$$lFHDZzSaH5XyQJIWi/fl4. encrypted
password debug $1$$lFHDZzSaH5XyQJIWi/fl4. encrypted
fixup pptp
fixup ftp
fixup irc
hostname firewall
domain-name cardiodx.com
name-server 10.10.37.21

interface eth0 module tg3
interface eth1 module tg3
interface eth2 module r8169
interface eth3 module r8169
interface eth4 module e1000
interface eth5 module e1000

#interface eth4 public

nameif eth0 lab
nameif eth1 internal
nameif eth2 dmz1
nameif eth3 dmz2
nameif eth4 comcast
nameif eth5 xo

interface lab address 10.10.47.1/24
interface internal address 10.10.37.1/21
interface dmz1 address 10.10.43.1/24
interface dmz2 address 10.10.53.1/24
interface comcast address 173.13.158.180/28
interface comcast address 173.13.158.181/28 secondary
interface xo address 67.95.201.194/27
interface xo address 67.95.201.198/27 secondary
interface xo address 67.95.201.195/27 secondary
interface xo address 67.95.201.197/27 secondary

# Add static routes -- dynamic routes should be added in post-boot script
route 12.149.54.90/32 67.95.201.193
route 12.3.153.0/24 67.95.201.193

route 66.18.99.68/32 67.95.201.193
route 66.18.106.160/27 67.95.201.193

port-forward 67.95.201.194 10.10.37.22 udp 1194 1194            # openvpn
port-forward 67.95.201.194 10.10.37.27 tcp 443 443              # https
port-forward 67.95.201.194 10.10.37.27 tcp 993 993              # imaps
port-forward 67.95.201.194 10.10.37.36 tcp 3389 3389            # rdp
port-forward 67.95.201.197 10.10.37.36 tcp 443 443              # https
#port-forward 67.95.201.194 67.95.201.196 tcp 80 80             # http
#proxyarp xo host 67.95.201.200 dmz1
proxyarp xo host 67.95.201.196 dmz1

icmp permit 10.10.32.0/21 all internal
icmp permit any echo-request comcast
icmp permit any echo-request xo
icmp permit any echo-request dmz1
icmp limit 10

access-list inout permit all 10.10.32.0/21 any

access-list outin permit udp any 10.10.37.22 1194               # openvpn
access-list outin permit tcp any 10.10.37.27 443                # https
access-list outin permit tcp any 10.10.37.27 993                # imaps
access-list outin permit tcp any 10.10.37.36 443                # https

access-list outdmz permit tcp any 67.95.201.196 25              # smtp
access-list outdmz permit tcp any 67.95.201.196 465             # ssmtp

#access-list outdmz permit tcp any 67.95.201.196 80             # http
#access-list outdmz permit tcp any 67.95.201.196 443            # https

access-list dmzin permit tcp 67.95.201.196 10.10.37.21 389      # ldap
access-list dmzin permit tcp 67.95.201.196 10.10.37.27 25       # mail
access-list dmzin permit udp 67.95.201.196 10.10.37.21 53       # dns
access-list dmzin permit udp 67.95.201.196 10.10.37.22 514      # syslog

access-list dmzout permit tcp 67.95.201.196 any 25              # smtp
access-list dmzout permit tcp 67.95.201.196 any 80              # http
access-list dmzout permit udp 67.95.201.196 any 123             # ntp

#access-list dmzall permit all 67.95.201.200 any

access-list infuse permit tcp 70.58.37.37 10.10.37.36 3389      # rdp
access-list infuse permit tcp 24.10.180.184 10.10.37.36 3389    # rdp
access-list infuse permit tcp 71.199.56.195 10.10.37.36 3389    # rdp
access-list infuse permit tcp 206.71.69.92 10.10.37.36 3389     # rdp

access-list inert2 permit tcp 10.10.32.0/21 12.3.153.12
access-list inert2 permit tcp 10.10.32.0/21 12.3.153.96
access-list inert2 permit tcp 10.10.32.0/21 12.3.153.97
access-list inert2 permit tcp 10.10.32.0/21 12.3.153.5
access-list inert2 permit icmp 12.3.153.0/24 any

access-list clinix permit tcp 10.10.32.0/21 66.18.106.160/27
access-list clinix permit tcp 66.18.106.160/27 10.10.36.42
access-list clinix permit tcp 66.18.106.160/27 10.10.37.106 9100
access-list clinix permit icmp 66.18.106.160/27 any

nat comcast 10.10.32.0/21
nat xo 10.10.32.0/21

ssh server enable 22
ssh 10.10.32.0/21
#qos rate 10000 10000
http server disable
http 10.10.32.0/21

pptp server enable
pptp proxyarp
pptp local-address 10.10.37.251
pptp address-pool 10.10.37.252 10.10.37.253

logging host 10.10.37.22
#logging forward-accept
#logging forward-deny

ipsec tunnel eRT-2 10.10.32.0/21 12.3.153.0/24 via 12.149.54.90
ipsec tunnel eRT-2 auth psk CDX2eResearch
ipsec tunnel eRT-2 ike cipher 3des
ipsec tunnel eRT-2 ike hash sha1
ipsec tunnel eRT-2 ike lifetime 3600
ipsec tunnel eRT-2 ike dh-group 2
ipsec tunnel eRT-2 esp cipher 3des
ipsec tunnel eRT-2 esp hash hmac_sha1
ipsec tunnel eRT-2 esp lifetime 3600
ipsec tunnel eRT-2 esp pfs-group 2

ipsec tunnel clinix 10.10.32.0/21 66.18.106.160/27 via 66.18.99.68
ipsec tunnel clinix auth psk cadx6795201194
ipsec tunnel clinix ike cipher 3des
ipsec tunnel clinix ike hash md5
ipsec tunnel clinix ike lifetime 3600
ipsec tunnel clinix ike dh-group 2
ipsec tunnel clinix esp cipher 3des
ipsec tunnel clinix esp hash hmac_md5
ipsec tunnel clinix esp lifetime 28800
ipsec tunnel clinix esp pfs-group 0

cchou@srikardesktop:/home/srikar$  more postboot 
# For machines in DMZ:
ip rule | grep fwmark
if [ $? != 0 ]; then
  ip rule add fwmark 4 table 4
  ip rule add fwmark 5 table 5
fi


# routing table for Comcast (4)
ip route add table 4 default via 173.13.158.190 dev eth4
# routing table for XO (5)
ip route add table 5 default via 67.95.201.193 dev eth5

# fwmark for comcast's public ips
iptables -t mangle -A PREROUTING -s 173.13.158.176/28 -d ! 10.0.0.0/8 -j MARK --set-mark 4
# fwmark for xo's public ips
iptables -t mangle -A PREROUTING -s 67.95.201.192/27 -d ! 10.0.0.0/8 -j MARK --set-mark 5


#
# load balancing (comcast and xo)
#

# Both Comcast and XO are up and running:
ip route add default scope global nexthop via 173.13.158.190 dev eth4 weight 5 nexthop via 67.95.201.193 dev eth5 weight 1

# If Comcast goes down:
# ip route replace default scope global via 67.95.201.193 dev eth5

# If XO goes down:
# ip route replace default scope global via 173.13.158.190 dev eth4


