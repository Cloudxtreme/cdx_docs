firewall traffic control

http://www.ceenet.org/workshops/lectures2000/Rafal_Maszkowski/routing-traffic/index.html
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
--
-- on cchoudesktop
--

vi cdx.tc

#include "fields.tc"
#include "ports.tc"

dev eth1 {
    egress {
        class ( <$server> ) if ip_dst:24 == 10.10.37.0 ;
        class ( <$other> )   if 1 ;

        htb () {
            class ( rate 53Mbps, ceil 53Mbps ) {
                $server   = class ( rate 10Mbps, ceil 53Mbps ) { sfq; } ;
                $other    = class ( rate  3Mbps, ceil  5Mbps ) { sfq; } ;
            }
        }
    }
}


# tcng cdx.tc 

--
-- on firewall, run the following commands
--

tc qdisc add dev eth1 handle 1:0 root dsmark indices 4 default_index 0
tc qdisc add dev eth1 handle 2:0 parent 1:0 htb
tc class add dev eth1 parent 2:0 classid 2:1 htb rate 6625000bps ceil 6625000bps
tc class add dev eth1 parent 2:1 classid 2:2 htb rate 1250000bps ceil 6625000bps
tc qdisc add dev eth1 handle 3:0 parent 2:2 sfq
tc class add dev eth1 parent 2:1 classid 2:3 htb rate 375000bps ceil 625000bps
tc qdisc add dev eth1 handle 4:0 parent 2:3 sfq
tc filter add dev eth1 parent 2:0 protocol all prio 1 tcindex mask 0x3 shift 0
tc filter add dev eth1 parent 2:0 protocol all prio 1 handle 2 tcindex classid 2:3
tc filter add dev eth1 parent 2:0 protocol all prio 1 handle 1 tcindex classid 2:2
tc filter add dev eth1 parent 1:0 protocol all prio 1 u32 match u32 0xa0a2500 0xffffff00 at 16 classid 1:1
tc filter add dev eth1 parent 1:0 protocol all prio 1 u32 match u32 0x0 0x0 at 0 classid 1:2


--tc -s qdisc show
tc -s qdisc show dev eth1
tc filter show dev eth1


tc qdisc del dev eth1 root
--tc qdisc del dev eth1 ingress

ip route show
ip -s link

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# more cdx.tc 
#include "fields.tc"
#include "ports.tc"

dev eth1 {
    egress {
        class ( <$internal> ) if ip_src:21 == 10.10.32.0 && ip_dst:21 == 10.10.32.0;
        class ( <$out_server> ) if ip_src:21 != 10.10.32.0 && ip_dst:24 == 10.10.37.0 ;
        class ( <$out_client> ) if ip_src:21 != 10.10.32.0 && ip_dst:24 != 10.10.37.0;
        class ( <$other> )   if 1 ;

        htb () {
            class ( rate 1024Mbps, ceil 1024Mbps ) {
                $internal   = class ( rate 1024Mbps, ceil 1024Mbps ) { sfq; } ;
                $out_server   = class ( rate 10Mbps, ceil 53Mbps ) { sfq; } ;
                $out_client   = class ( rate 3Mbps, ceil 5Mbps ) { sfq; } ;
                $other    = class ( rate  1Mbps, ceil  3Mbps ) { sfq; } ;
            }
        }
    }
}

root@cchoudesktop:/root/tmp# tcng cdx.tc 

# ================================ Device eth1 ================================

tc qdisc del dev eth1 root

tc qdisc add dev eth1 handle 1:0 root dsmark indices 8 default_index 0
tc qdisc add dev eth1 handle 2:0 parent 1:0 htb
tc class add dev eth1 parent 2:0 classid 2:1 htb rate 128000000bps ceil 128000000bps
tc class add dev eth1 parent 2:1 classid 2:2 htb rate 128000000bps ceil 128000000bps
tc qdisc add dev eth1 handle 3:0 parent 2:2 sfq
tc class add dev eth1 parent 2:1 classid 2:3 htb rate 1250000bps ceil 6625000bps
tc qdisc add dev eth1 handle 4:0 parent 2:3 sfq
tc class add dev eth1 parent 2:1 classid 2:4 htb rate 375000bps ceil 625000bps
tc qdisc add dev eth1 handle 5:0 parent 2:4 sfq
tc class add dev eth1 parent 2:1 classid 2:5 htb rate 125000bps ceil 375000bps
tc qdisc add dev eth1 handle 6:0 parent 2:5 sfq
tc filter add dev eth1 parent 2:0 protocol all prio 1 tcindex mask 0x7 shift 0
tc filter add dev eth1 parent 2:0 protocol all prio 1 handle 4 tcindex classid 2:5
tc filter add dev eth1 parent 2:0 protocol all prio 1 handle 3 tcindex classid 2:4
tc filter add dev eth1 parent 2:0 protocol all prio 1 handle 2 tcindex classid 2:3
tc filter add dev eth1 parent 2:0 protocol all prio 1 handle 1 tcindex classid 2:2
tc filter add dev eth1 parent 1:0 protocol all prio 1 u32 match u32 0xa0a2000 0xfffff800 at 12 match u32 0xa0a2000 0xfffff800 at 16 classid 1:1
tc filter add dev eth1 parent 1:0 protocol all prio 1 u32 match u32 0xa0a2000 0xfffff800 at 12 classid 1:4
tc filter add dev eth1 parent 1:0 protocol all prio 1 u32 match u32 0xa0a2500 0xffffff00 at 16 classid 1:2
tc filter add dev eth1 parent 1:0 protocol all prio 1 u32 match u32 0x0 0x0 at 0 classid 1:3


