
col segment for a30;
col owner for a10;
col tablespace_name for a15;
SELECT owner, segment_name "Segment" , segment_type "Type" 
FROM dba_segments
where tablespace_name = 'SCE_CONTENT';


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
./dump_all_file_contents.rb waban21 data sceschema waban21sce > run2.log 2>&1

sqlplus system
CREATE TABLESPACE "SCE_TMP" LOGGING
DATAFILE '/u01/app/oracle/oradata/ORCL/sec_tmp.dbf' SIZE 200M REUSE
AUTOEXTEND ON
NEXT  1280K MAXSIZE UNLIMITED
EXTENT MANAGEMENT LOCAL SEGMENT
SPACE MANAGEMENT  AUTO;

sqlplus sceschema
UPDATE versioneddocument SET content = EMPTY_BLOB();
ALTER TABLE versioneddocument DEALLOCATE UNUSED KEEP 0M;
ALTER TABLE versioneddocument MOVE LOB(content) STORE AS ( TABLESPACE SCE_TMP);

sqlplus gtmeta
ALTER TABLE  AUD_META_ANNOTATION  MOVE LOB(CONTENT_BLOB) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_ANNOTATION  MOVE LOB(CONTENT_BLOB) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  AUD_META_QUERY  MOVE LOB(XML) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  AUD_META_TARGET_OBJECT_TYPE  MOVE LOB(ICON) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_DOC_FROM_QUERY  MOVE LOB(QUERY_XML) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_QUERY  MOVE LOB(XML) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_STYLE_SHEET  MOVE LOB(CSS_TXT) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_TARGET_OBJECT_TYPE  MOVE LOB(ICON) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_VIEWER_FORMAT  MOVE LOB(FORMAT) STORE AS ( TABLESPACE SCE_TMP);

sqlplus system
drop tablespace sce_content;

CREATE TABLESPACE "SCE_CONTENT" LOGGING
DATAFILE '/u01/app/oracle/oradata/ORCL/sec_content_01.dbf' SIZE 200M REUSE
AUTOEXTEND ON
NEXT  1280K MAXSIZE UNLIMITED
EXTENT MANAGEMENT LOCAL SEGMENT
SPACE MANAGEMENT  AUTO;

sqlplus gtmeta
ALTER TABLE  AUD_META_ANNOTATION  MOVE LOB(CONTENT_BLOB) STORE AS ( TABLESPACE SCE_CONTENT);
ALTER TABLE  META_ANNOTATION  MOVE LOB(CONTENT_BLOB) STORE AS ( TABLESPACE SCE_CONTENT);
ALTER TABLE  AUD_META_QUERY  MOVE LOB(XML) STORE AS ( TABLESPACE SCE_CONTENT);
ALTER TABLE  AUD_META_TARGET_OBJECT_TYPE  MOVE LOB(ICON) STORE AS ( TABLESPACE SCE_CONTENT);
ALTER TABLE  META_DOC_FROM_QUERY  MOVE LOB(QUERY_XML) STORE AS ( TABLESPACE SCE_CONTENT);
ALTER TABLE  META_QUERY  MOVE LOB(XML) STORE AS ( TABLESPACE SCE_CONTENT);
ALTER TABLE  META_STYLE_SHEET  MOVE LOB(CSS_TXT) STORE AS ( TABLESPACE SCE_CONTENT);
ALTER TABLE  META_TARGET_OBJECT_TYPE  MOVE LOB(ICON) STORE AS ( TABLESPACE SCE_CONTENT);
ALTER TABLE  META_VIEWER_FORMAT  MOVE LOB(FORMAT) STORE AS ( TABLESPACE SCE_CONTENT);

sqlplus sceschema
ALTER TABLE versioneddocument MOVE LOB(content) STORE AS ( TABLESPACE SCE_CONTENT);

select table_name, index_name, status from user_indexes where status <> 'VALID';
	VERSIONEDDOCUMENT	       PK_VERSIONEDDOCUMENT	      UNUSABLE
	VERSIONEDDOCUMENT	       IDX_VDOC_ROOT_DOC_ID	      UNUSABLE
	VERSIONEDDOCUMENT	       IDX_VDOC_CONTENT_TEXT	      UNUSABLE

alter index PK_VERSIONEDDOCUMENT rebuild;
alter index IDX_VDOC_ROOT_DOC_ID rebuild;
??? alter index IDX_VDOC_CONTENT_TEXT rebuild;
  sh: Illegal option -p
  sh: Illegal option -p

./load_all_file_contents.rb waban21 data sceschema waban21sce > run3.log 2>&1

drop tablespace sce_tmp;

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
UPDATE AUD_META_ANNOTATION SET CONTENT_BLOB = EMPTY_BLOB();
UPDATE META_ANNOTATION SET CONTENT_BLOB = EMPTY_BLOB();
update AUD_META_QUERY set XML =EMPTY_BLOB();
update AUD_META_TARGET_OBJECT_TYPE set ICON =EMPTY_BLOB();
update META_DOC_FROM_QUERY set QUERY_XML =EMPTY_BLOB();
update META_QUERY set XML =EMPTY_BLOB();
update META_STYLE_SHEET set CSS_TXT =EMPTY_BLOB();
update META_TARGET_OBJECT_TYPE set ICON =EMPTY_BLOB();
--update META_UTILITIES_LOG set LOG_BLOB =EMPTY_BLOB();
update META_VIEWER_FORMAT set FORMAT =EMPTY_BLOB();

alter table AUD_META_ANNOTATION DEALLOCATE UNUSED KEEP 0M;
alter table META_ANNOTATION DEALLOCATE UNUSED KEEP 0M;
alter table AUD_META_QUERY DEALLOCATE UNUSED KEEP 0M;
alter table AUD_META_TARGET_OBJECT_TYPE DEALLOCATE UNUSED KEEP 0M;
alter table META_DOC_FROM_QUERY DEALLOCATE UNUSED KEEP 0M;
alter table META_QUERY DEALLOCATE UNUSED KEEP 0M;
alter table META_STYLE_SHEET DEALLOCATE UNUSED KEEP 0M;
alter table META_TARGET_OBJECT_TYPE DEALLOCATE UNUSED KEEP 0M;
alter table META_UTILITIES_LOG DEALLOCATE UNUSED KEEP 0M;
alter table META_VIEWER_FORMAT DEALLOCATE UNUSED KEEP 0M;

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
http://halisway.blogspot.com/2007/06/reclaiming-lob-space-in-oracle.html

select round(sum(bytes)/1024/1024) Mb from dba_segments where segment_name='SYS_LOB0000051363C00006$$';

alter table lob_test modify lob (data) (shrink space);


SELECT owner, segment_name "Segment" , segment_type "Type"
FROM dba_segments
where tablespace_name = 'SCE_CONTENT';


ALTER TABLE  AUD_META_ANNOTATION  MOVE LOB(CONTENT_BLOB) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_ANNOTATION  MOVE LOB(CONTENT_BLOB) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  AUD_META_QUERY  MOVE LOB(XML) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  AUD_META_TARGET_OBJECT_TYPE  MOVE LOB(ICON) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_DOC_FROM_QUERY  MOVE LOB(QUERY_XML) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_QUERY  MOVE LOB(XML) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_STYLE_SHEET  MOVE LOB(CSS_TXT) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_TARGET_OBJECT_TYPE  MOVE LOB(ICON) STORE AS ( TABLESPACE SCE_TMP);
ALTER TABLE  META_VIEWER_FORMAT  MOVE LOB(FORMAT) STORE AS ( TABLESPACE SCE_TMP);

drop tablespace sce_content;










