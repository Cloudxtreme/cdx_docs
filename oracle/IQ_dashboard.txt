03/01/12 
OK, dashboard crashed during memory upgrade.  It's probably a good time to prepare for IQ.

started around 7ish pm.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-- system 
apt-get update -o Acquire::http::No-Cache=True
wajig update
wajig upgrade
wajig dist-upgrade

wajig install subversion -y

-- ruby
wajig install ruby rdoc irb libyaml-ruby libzlib-ruby ri libopenssl-ruby ruby1.8-dev libldap-ruby1.8 libpgsql-ruby -y

-- rails
wget http://rubyforge.org/frs/download.php/69365/rubygems-1.3.6.tgz
tar zxvf rubygems-1.3.6.tgz
cd rubygems-1.3.6/
ruby setup.rb
ln -s /usr/bin/gem1.8 /usr/bin/gem

-- mysql binary
wajig install libmysqlclient15-dev mysql-server -y
  secret07

-- gems
 2031  cd /usr/lib/ruby/gems/1.8/gems/activerecord-2.3.8/
 2041  tar czvf ~/gems.tar.gz gems/
	& copy over

		-- gem install actionmailer -v 2.3.8 --no-rdoc --no-ri
		-- gem install actionpack -v 2.3.8 --no-rdoc --no-ri
		-- gem install activerecord -v 2.3.8 --no-rdoc --no-ri
		-- gem install activeresource -v 2.3.8 --no-rdoc --no-ri
		-- gem install activesupport -v 2.3.8 --no-rdoc --no-ri
		-- gem install authlogic -v 2.1.5 --no-rdoc --no-ri
		-- gem install ruby-net-ldap -v 0.0.4 --no-rdoc --no-ri
		-- gem install rails -v 2.3.8 --no-rdoc --no-ri
		-- gem install mysql --no-rdoc --no-ri

-- sf.com gem
cd svn/
svn co svn://svn/datawarehouse/trunk/reports/
cd reports/
--scp activerecord-activesalesforce-adapter-2.2.2.gem
gem install rails --no-rdoc --no-ri (will install 3.2.9)
gem install activerecord-activesalesforce-adapter-2.2.2.gem --no-rdoc --no-ri


gem install activerecord-activesalesforce-adapter-2.2.2.gem --no-rdoc --no-ri
	*** test - see lucid_image.txt??????
irb
require 'rubygems'
gem 'activerecord', '= 2.3.8'
require 'active_record'
ActiveRecord::Base.establish_connection(:adapter => 'activesalesforce', :username => 'hub@cardiodx.com', :password => 'test789')

class Account < ActiveRecord::Base; end
class User < ActiveRecord::Base; end

userid2email = {}
User.find(:all).each {|u| userid2email[u.id] = u.email}
accountid2email = {}
Account.find(:all).each {|acc|
   accountid2email[acc.account_id__c] = userid2email[acc.owner_id]
}

-- oracle
cd ~/gdrive/it/software/Oracle 10g/instantclient_10.204/x86_64
scp * root@dashboard1:

wajig install ./oracle-instantclient-basic_10.2.0.4-2_amd64.deb ./oracle-instantclient-devel_10.2.0.4-2_amd64.deb ./oracle-instantclient-sqlplus_10.2.0.4-2_amd64.deb

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/oracle/10.2.0.4/client64/lib
export TNS_ADMIN=.
export ORACLE_HOME=.

vi tnsnames.ora
RDLIMS =
  (DESCRIPTION =
    (ADDRESS_LIST =
        (ADDRESS =
          (COMMUNITY = tcp.world)
          (PROTOCOL = TCP)
          (Host = rdlims)
          (Port = 1521)
        )
    )
    (CONNECT_DATA = (SID = ORCL)
    )
  )

/usr/lib/oracle/10.2.0.4/client64/bin/sqlplus system/rdlimssys246@rdlims

--
-- dashboard
--

groupadd -g 1001 rails
useradd -g 1001 -u 1001 -d /home/rails -s /bin/bash rails
mkdir /home/rails 
chown rails:rails /home/rails
su - rails
copy .bashrc .
copy .profile .

vi .bashrc
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/oracle/10.2.0.4/client64/lib

export TNS_ADMIN=/home/rails
export ORACLE_HOME=/home/rails

tar zxvf dashboard.restore.tar.gz
mv dashboard /home/rails/

su - rails
cp dashboard/tnsnames.ora .
/usr/lib/oracle/10.2.0.4/client64/bin/sqlplus system/rdlimssys246@rdlims

gem install ruby-oci8 -v 1.0.4 --no-rdoc --no-ri
gem install activerecord-oracle-adapter --source http://gems.rubyonrails.org --no-rdoc --no-ri

--tar file from bksrv/daily.0
get code form svn://svn/dashboard/trunk

-- mysql 
mysql -u root -p 
create database dashboard;

cd /home/rails/dashboard/db
gzip -d dashboard.dump.gz
mysql -u root -p -A < dashboard.dump

mysql -u root -p dashboard
show tables;

~/dashboard$ ./start.sh 
http://dashboard1.cardiodx.com:3000

-- apache
wajig install apache2 -y
cd gdrive/it/Private/ssl/wildcard/08-14-2012/apache/
scp * root@dashboard1:/etc/apache2/ssl

chown www-data *
chmod 660 *


cd /etc/apache2/sites-available
mv default default.orig
vi default
NameVirtualHost dashboard1.cardiodx.com:80
<VirtualHost dashboard1.cardiodx.com:80>
  ServerName dashboard1.cardiodx.com
  Redirect permanent / https://dashboard1.cardiodx.com/
</VirtualHost>

<VirtualHost dashboard1.cardiodx.com:443>
  ServerName dashboard1.cardiodx.com
  SSLEngine on
  SSLCertificateFile /etc/apache2/ssl/wildcard.cardiodx.com.crt
  SSLCertificateKeyFile /etc/apache2/ssl/wildcard.cardiodx.com.key
  SSLCertificateChainFile /etc/apache2/ssl/gd_bundle.crt

  ProxyPass / http://dashboard1.cardiodx.com:3000/
  ProxyPassReverse / http://dashboard1.cardiodx.com:3000/
  ProxyPreserveHost On
  RequestHeader set X_FORWARDED_PROTO 'https'

#  ErrorLog "|/usr/bin/logger -p local0.err"
#  LogFormat "%v \"%r\" %>s %b \"%{Referer}i\"" privacy_format
#  CustomLog "|/usr/bin/logger -p local1.info" privacy_format
#  LogLevel warn
</VirtualHost>

cd mods-available
vi proxy.conf 
  #Deny from all
  Allow from .cardiodx.com

a2enmod ssl
a2enmod rewrite
a2enmod proxy_http
a2enmod headers

/etc/init.d/apache2 restart


https://dashboard.cardiodx.com/
  should be re-routed to http://dashboard.cardiodx.com:3000/

-- passenger
wajig install libcurl4-openssl-dev build-essential zlib1g-dev apache2-prefork-dev libapr1-dev libaprutil1-dev -y

gem install passenger --no-rdoc --no-ri
passenger-install-apache2-module

cat > /etc/apache2/mods-available/passenger.conf<<EOF
PassengerRoot /usr/lib/ruby/gems/1.8/gems/passenger-3.0.11
PassengerRuby /usr/bin/ruby1.8
EOF

cat > /etc/apache2/mods-available/passenger.load<<EOF
LoadModule passenger_module /usr/lib/ruby/gems/1.8/gems/passenger-3.0.11/ext/apache2/mod_passenger.so
EOF

cd /etc/apache2/sites-available
mv default default.1

vi default
<VirtualHost *:80>
  ServerName dashboard1.cardiodx.com
  Redirect / https://dashboard1.cardiodx.com/
</VirtualHost>

<VirtualHost *:443>
  ServerName dashboard1.cardiodx.com
  RailsEnv development

  SSLEngine on
  SSLCertificateFile /etc/apache2/ssl/wildcard.cardiodx.com.crt
  SSLCertificateKeyFile /etc/apache2/ssl/wildcard.cardiodx.com.key
  SSLCertificateChainFile /etc/apache2/ssl/gd_bundle.crt

  RequestHeader set X_FORWARDED_PROTO 'https'
  DocumentRoot /home/rails/dashboard/public

  ErrorLog "|/usr/bin/logger -p local0.err"
  LogFormat "%h %l %u %t \"%r\" %>s %b" privacy_format
  CustomLog "|/usr/bin/logger -p local1.info" privacy_format
</VirtualHost>

a2enmod passenger

/etc/init.d/apache2 restart

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
--
-- for rscript
--
wajig install r-base

R
install.packages("multicore")

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NOTE!!!!
~~~~~~~~
I go the following problems: 
	libclntsh.so.10.1 cannot open shared object file no such file or directory
	/usr/lib/ruby/gems/1.8/gems/ruby-oci8-1.0.4/lib/oci8lib.so

So, I copy it over:
	cp /usr/lib/ruby/gems/1.8/gems/ruby-oci8-1.0.4/lib/oci8lib.so /usr/lib/oracle/10.2.0.4/client64/lib/oci8lib.so
	/etc/init.d/apache2 restart

	-- I also did: (probably not helpful)
vi /etc/ld.so.conf.d/oracle.conf
/usr/lib/oracle/10.2.0.4/client64/lib

	ldconfig

And It's fine now:
	https://dashboard1.cardiodx.com

And I remove the file: 
	rm /usr/lib/oracle/10.2.0.4/client64/lib/oci8lib.so

reboot the machine <<<<<-------

and it worked!!
	https://dashboard1.cardiodx.com

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

--
-- cron jobs
--
get ssh.tar.gz over and untar it 
root@bksrv:/backup/daily.0/dashboard/home/rails/ssh.tar.gz

cd /etc/cron.daily
vi dashboard
su - rails -c 'cd dashboard/fedex; rsync root@cbshub:/home/mingham/hub/trunk/hub/fedex_delivery_notification/saved_fedex_reports/fedex_tracking_results.*_060001.txt .; ./rename.sh'
su - rails -c 'cd dashboard/db; ./fetch.rb `date +"%m"`'

chmod 755 dashboard

vi mysql
mysqldump -uroot --password=secret07 --all-database | gzip > /home/rails/dashboard/db/dashboard.dump.gz

chmod 755 mysql



