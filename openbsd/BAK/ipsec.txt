http://www.kernel-panic.it/openbsd/vpn/vpn3.html

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# vi /etc/sysctl.conf
net.inet.esp.enable=1
net.inet.ah.enable=1


--ifconfig enc0 up
--vi /etc/hostname.enc0
--up


# more ipsec.conf
(host-1) ike esp from 192.168.10.0/24 to 10.10.32.0/21 peer 67.95.201.198 psk cdxTest123
(host-2) ike esp from 10.10.32.0/21 to 192.168.10.0/24 peer 67.95.201.201 psk cdxTest123

# isakmpd -K -d
isakmpd -Kvd

ipsecctl -nvf /etc/ipsec.conf
ipsecctl -f /etc/ipsec.conf


ipsecctl -s all
FLOWS:
flow esp in from 10.10.32.0/21 to 192.168.10.0/24 peer 67.95.201.198 srcid 67.95.201.201/32 dstid 67.95.201.198/32 type use
flow esp out from 192.168.10.0/24 to 10.10.32.0/21 peer 67.95.201.198 srcid 67.95.201.201/32 dstid 67.95.201.198/32 type require

SAD:
esp tunnel from 67.95.201.201 to 67.95.201.198 spi 0x52650ac5 auth hmac-sha2-256 enc aes
esp tunnel from 67.95.201.198 to 67.95.201.201 spi 0xf277eb27 auth hmac-sha2-256 enc aes


cchou@cchoudesktop:~$ ping 192.168.10.2
cchou@cchoudesktop:~$ rdesktop 192.168.10.2


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

C set [Phase 1]:67.95.201.201=peer-67.95.201.201 force
C set [peer-67.95.201.201]:Phase=1 force
C set [peer-67.95.201.201]:Address=67.95.201.201 force
C set [peer-67.95.201.201]:Authentication=cdxTest123 force
C set [peer-67.95.201.201]:Configuration=phase1-peer-67.95.201.201 force

C set [phase1-peer-67.95.201.201]:EXCHANGE_TYPE=ID_PROT force
C add [phase1-peer-67.95.201.201]:Transforms=AES-SHA force

C set [from-10.10.32.0/21-to-192.168.10.0/24]:Phase=2 force
C set [from-10.10.32.0/21-to-192.168.10.0/24]:ISAKMP-peer=peer-67.95.201.201 force
C set [from-10.10.32.0/21-to-192.168.10.0/24]:Configuration=phase2-from-10.10.32.0/21-to-192.168.10.0/24 force
C set [from-10.10.32.0/21-to-192.168.10.0/24]:Local-ID=from-10.10.32.0/21 force
C set [from-10.10.32.0/21-to-192.168.10.0/24]:Remote-ID=to-192.168.10.0/24 force

C set [phase2-from-10.10.32.0/21-to-192.168.10.0/24]:EXCHANGE_TYPE=QUICK_MODE force
C set [phase2-from-10.10.32.0/21-to-192.168.10.0/24]:Suites=QM-ESP-AES-SHA2-256-PFS-SUITE force

C set [from-10.10.32.0/21]:ID-type=IPV4_ADDR_SUBNET force
C set [from-10.10.32.0/21]:Network=10.10.32.0 force
C set [from-10.10.32.0/21]:Netmask=255.255.248.0 force

C set [to-192.168.10.0/24]:ID-type=IPV4_ADDR_SUBNET force
C set [to-192.168.10.0/24]:Network=192.168.10.0 force
C set [to-192.168.10.0/24]:Netmask=255.255.255.0 force

C add [Phase 2]:Connections=from-10.10.32.0/21-to-192.168.10.0/24

