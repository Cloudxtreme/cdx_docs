--
-- host 1 (w/ dmz balancing)
--

# more hostname.em0 
inet 173.13.158.180 255.255.255.240
#inet alias 173.13.158.182 255.255.255.240
#
#!route add -mpath default 173.13.158.190


# more hostname.em1 
inet 67.95.201.198 255.255.255.224
inet alias 67.95.201.199 255.255.255.224

#!route add -mpath default 67.95.201.193

# more hostname.re0 
inet 10.10.43.1 255.255.255.0

# more hostname.bge1 
inet 10.10.37.2 255.255.248.0

# more isakmp.conf   
[General]
Default-phase-1-lifetime=3600,60:86400
Default-phase-2-lifetime=3600,60:86400
# DPD-check-interval=30

# more ipsec.conf    
#ike esp from 10.10.32.0/21 to 192.168.10.0/24 peer 67.95.201.201 psk cdxTest123
# Test
ike esp from 10.10.32.0/21 to 192.168.10.0/24 peer 67.95.201.201 \
 main auth hmac-sha1 enc 3des group modp1024 \
 quick auth hmac-sha1 enc 3des group modp1024 \
 psk cdxTest123

## eRT-2
#ike esp from 10.10.32.0/21 to 12.3.153.0/24 peer 12.149.54.90 \
# main auth hmac-sha1 enc 3des group modp1024 \
# quick auth hmac-sha1 enc 3des group modp1024 \
# psk CDX2eResearch
#
## clinix
#ike esp from 10.10.32.0/21 to 66.18.106.160/27 peer 66.18.99.68 \
#  main auth hmac-md5 enc 3des group modp1024 \
#  quick auth hmac-md5 enc 3des group none \
#  psk cadx6795201194
#

# more pf.conf   
int_if = "bge1"
cc_if = "em0"
xo_if = "em1"
dmz_if = "re0"
local_if = "lo0"

cc_gw = "173.13.158.190"
xo_gw = "67.95.201.193"
int_net = "10.10.32.0/21"

remote_gw = "67.95.201.201"
remote_net = "192.168.10.0/24"
ert_gw = "12.149.54.90"
clinix_gw = "66.18.99.68"

block in
pass out keep state

pass in on $int_if

nat on $xo_if -> ($xo_if)
binat on $xo_if from 10.10.43.2 to any -> 67.95.201.199

pass in on $xo_if proto icmp to any
pass in on $xo_if proto udp from $remote_gw to $xo_if port {isakmp, ipsec-nat-t}
pass in on $xo_if proto esp from $remote_gw to $xo_if

pass in quick on enc0 proto icmp
pass in quick on enc0 proto ipencap all
pass in quick on enc0 proto tcp from $remote_net to $int_net port 22

pass in on $dmz_if proto tcp to any port {http,https} keep state
pass in on $dmz_if proto icmp to any keep state
pass in on $dmz_if proto udp to any port domain keep state

rdr pass on $xo_if proto tcp to 67.95.201.198 port 80 -> 10.10.35.17
rdr pass on $xo_if proto tcp to 67.95.201.199 port 80 -> 10.10.43.2

#load_balance_route  = "route-to { (" $cc_if $cc_gw "), (" $xo_if $xo_gw ") } round-robin"
#pass in on $int_if $load_balance_route proto tcp to ! $int_net flags S/SA modulate state
#pass in on $int_if $load_balance_route proto { udp, icmp } to ! $int_net keep state


# netstat -nr | grep 192
67.95.201.192/27   link#2             UC         2        0     -     4 em1
192.168.10/24      0     10.10.32/21        0     0     67.95.201.201/esp/use/in
10.10.32/21        0     192.168.10/24      0     0     67.95.201.201/esp/require/out

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
--
-- host 2
--

# more hostname.bge0 
hostname.bge0: No such file or directory


# cd /etc


# more hostname.bge0 
inet 67.95.201.201 255.255.255.224

!route add -net 10.10.32.0/21 67.95.201.193

# more hostname.em0  
inet 192.168.10.1 255.255.255.0

# more mygate 
67.95.201.193


# more isakmpd.conf
[General]
Default-phase-1-lifetime=3600,60:86400
Default-phase-2-lifetime=3600,60:86400


# more ipsec.conf
ike esp from 192.168.10.0/24 to 10.10.32.0/21 peer 67.95.201.198 \
  main auth hmac-sha1 enc 3des group modp1024 \
  quick auth hmac-sha1 enc 3des group modp1024 \
  psk cdxTest123


# more pf.conf
xo = "bge0"
internal = "em0"
local = "lo0"
remote_gw = "67.95.201.198"

block in
pass out keep state

nat on $xo -> ($xo)

pass in on $xo proto tcp from 67.95.201.192/27 to any port 22

pass in on $internal
pass in on $xo proto icmp to any

pass in on $xo proto udp from $remote_gw to $xo port {isakmp, ipsec-nat-t}
pass in on $xo proto esp from $remote_gw to $xo

pass in quick on enc0 proto icmp 
pass in quick on enc0 proto ipencap all
pass in quick on enc0 proto tcp from 10.10.32.0/21 to 192.168.10.2/32 port 3389


# netstat -nr | grep 192
67.95.201.192/27   link#1             UC         3        0     -     4 bge0
192.168.10/24      link#2             UC         1        0     -     4 em0
192.168.10.2       00:16:41:57:d7:a7  UHLc       0       13     -     4 em0
10.10.32/21        0     192.168.10/24      0     0     67.95.201.198/esp/use/in
192.168.10/24      0     10.10.32/21        0     0     67.95.201.198/esp/require/out


