[general]
static=yes
writeprotect=no
autofallthrough=no
clearglobalvars=yes

[globals]
CDXCALLERID=6504752788
NUFONE=IAX2/cardiodx@NuFone
JNCTN=IAX2/cardiodx@jnctn_out
PSTN=DAHDI/g1
ATTENDANT=SIP/2757&SIP/2791


[macro-stdexten]
exten => s, 1, GotoIf($["${CONTEXT}" != "pstn"]?2)
exten => s, 2, Set(NUMBERCALLED=${MACRO_EXTEN})
exten => s, 3, Answer
exten => s, 4, Ringing
exten => s, 5, Wait(5) 
exten => s, 6, Dial(${ARG1},20)
exten => s, 7, Voicemail(u${MACRO_EXTEN})
exten => s, 8, Hangup
; If SIP device is not registered HANGUPCAUSE is set to 3
exten => s, 107, GoToIf($[${HANGUPCAUSE} = 3]?7) 
exten => s, 108, Voicemail(b${MACRO_EXTEN})
exten => s, 109, Hangup

[macro-faxexten]
exten => s, 1, Dial(${ARG1},20)
exten => s, 2, Congestion
exten => s, 102, Congestion

[macro-attendant]
exten => s,1,Set(NUMBERCALLED=${MACRO_EXTEN})
exten => s,2, Answer
exten => s,3, Ringing
exten => s,4, Wait(5)
exten => s,5,Dial(${ATTENDANT},20)
exten => s,3,Goto(company-directory,s,1)
exten => s,106,Goto(company-directory,s,1)
exten => t,1,Goto(company-directory,s,1)

[macro-novmexten]
exten => s,1,Dial(${ARG1},20)
exten => s,2,Playback(vm-goodbye)
exten => s,3,Hangup
exten => s,102,Congestion

[macro-nufonetrunk]
exten => s, 1, Set(CALLERID(num)=${CDXCALLERID})
exten => s, 2, Dial(${NUFONE}/${ARG1})
exten => s, 102, Hangup

[macro-jnctntrunk]
exten => s, 1, Set(CALLERID(num)=${CDXCALLERID})
exten => s, 2, Dial(${JNCTN}/${ARG1})
exten => s, 102, Hangup

[macro-pstntrunk]
;exten => s, 1, NoOp(${CALLERIDNUM})
;exten => s, 2, Set(CALLERID(num)=650475${CALLERIDNUM})
;exten => s, 3, Dial(${PSTN}/${MACRO_EXTEN})
;exten => s, 104, Hangup

exten => s, 1, NoOp(${CALLERID(num)})
exten => s, 2, Set(CALLERID(num)=${IF($["${CALLERID(num):0:2}" = "27"]?650475${CALLERID(num)}:${IF($["${CALLERID(num):0:2}" = "01"]?650319${CALLERID(num)}:${CALLERID(num)})})})
exten => s, 3, Dial(${PSTN}/${MACRO_EXTEN})
exten => s, 4, Hangup
exten => s, 105, Hangup

;exten => s, 2, GoToIf($["${CALLERIDNUM:0:2}" = "27"]?3:6)
;exten => s, 6, Set(CALLERID(num)=650319${CALLERIDNUM})
;exten => s, 7, Dial(${PSTN}/${MACRO_EXTEN})
;exten => s, 8, Hangup
;exten => s, 105, Hangup
;exten => s, 108, Hangup

[macro-intltrunk]
exten => s,1,SetCallerID(${CDXCALLERID})
exten => s,2,Dial(${JNCTN}/${MACRO_EXTEN})
exten => s,3,Hangup

[macro-fax]
exten => s, 1, NoOp(${NUMBERCALLED})
exten => s, n, LDAPGet(USERNAME=username)
exten => s, n, Dial(IAX2/iaxmodem1/${USERNAME})
exten => s, n, Dial(IAX2/iaxmodem2/${USERNAME})
exten => s, n, Dial(IAX2/iaxmodem3/${USERNAME})
exten => s, n, Hangup

[oldextensions]
exten => 201,1,Goto(cdxextensions,2789,1)
exten => _2[012]X,1,Goto(cdxextensions,27${EXTEN:1},1)
exten => 284,1,Goto(cdxextensions,2757,1)
exten => 285,1,Goto(cdxextensions,2724,1)
exten => 288,1,Goto(cdxextensions,2723,1)
exten => 299,1,Goto(cdxextensions,2777,1)

[cdxextensions]
exten => _270N,1,Macro(stdexten,SIP/${EXTEN})
exten => _271X,1,Macro(stdexten,SIP/${EXTEN})
exten => _272X,1,Macro(stdexten,SIP/${EXTEN})
exten => _273X,1,Macro(stdexten,SIP/${EXTEN})
exten => _274X,1,Macro(stdexten,SIP/${EXTEN})
exten => _275[0-6],1,Macro(stdexten,SIP/${EXTEN})
exten => _2757,1,Macro(attendant,SIP/${EXTEN})
exten => _275[8-9],1,Macro(stdexten,SIP/${EXTEN})
exten => _276X,1,Macro(stdexten,SIP/${EXTEN})
exten => _277[0-5],1,Macro(stdexten,SIP/${EXTEN})
exten => 2777,1,VoicemailMain
exten => 2777,2,Hangup
exten => _278[0-7],1,Macro(stdexten,SIP/${EXTEN})
exten => 2789,hint,SIP/2789
exten => 2789,1,Macro(stdexten,SIP/${EXTEN})
exten => _279[1-8],1,Macro(novmexten,SIP/${EXTEN})
;exten => 2799,1,Macro(faxexten,SIP/${EXTEN})

;
; 09xx extensions (319-0914 ~ 319-0973)
;
exten => 0914,1,Macro(stdexten,SIP/${EXTEN})
exten => 0915,1,Goto(give-dialtone,s,1) ; phone number for Philip to dial in
exten => _091[6-8],1,Macro(stdexten,SIP/${EXTEN})
;exten => 0919 (Fax for CLIA Lab)
exten => _092[0-4],1,Macro(stdexten,SIP/${EXTEN})

; Lims support call
exten => 0930,1,Answer
exten => 0930,2,Ringing
exten => 0930,3,Wait(2)
exten => 0930,4,Set(CALLERID(num)=${IF($["${CALLERID(num):0:2}" = "27"]?650475${CALLERID(num)}:${IF($["${CALLERID(num):0:2}" = "01"]?650319${CALLERID(num)}:${CALLERID(num)})})})
exten => 0930,5,GotoIfTime(08:00-22:00|*|*|*?${EXTEN},8)
exten => 0930,6,GotoIfTime(22:00-02:00|*|*|*?${EXTEN},8)
exten => 0930,7,GotoIfTime(02:00-08:00|*|*|*?${EXTEN},8)
exten => 0930,8,Queue(lims-0822)
exten => 0930,9,Queue(lims-2202)
exten => 0930,10,Queue(lims-0208)
exten => 0930,11,Hangup

; for sales reps
exten => _093[1-9],1,Macro(stdexten,SIP/${EXTEN})

; Direct 47.. extensions directly to voicemail
exten => _47XX,1,Voicemail(u2${EXTEN:1})

; Faxes sent directly to employees extensions should be dealt with differently from those sent to the fax extension
;exten => fax,1,Macro(fax)
;exten => fax,2,Congestion
;exten => fax,102,Congestion

exten => fax,1,GotoIf($["${NUMBERCALLED}" = "2799"]?4)
exten => fax,2,GotoIf($["${NUMBERCALLED}" = "0919"]?6)
exten => fax,3,Macro(fax)
exten => fax,4,Dial(SIP/2799,30)
exten => fax,5,Congestion
exten => fax,6,Dial(SIP/0919,30)
exten => fax,7,Congestion
exten => fax,104,Congestion
exten => fax,105,Congestion
exten => fax,107,Congestion


[company-directory]
include => oldextensions
include => cdxextensions

exten => s,1,SetCallerID(${CALLERID})
exten => s,2,Set(TIMEOUT(response)=2)
exten => s,3,Answer
exten => s,4,Background(cdx-welcome)
exten => s,5,Set(TIMEOUT(response)=15)
exten => s,6,Voicemail(u2757)

exten => i,1,Playback(pbx-invalid)
exten => i,2,Goto(s,6)

exten => t,1,Playback(vm-goodbye)
exten => t,2,Hangup

exten => 411,1,Directory(default)
exten => 411,2,Hangup


[conferences]
exten => s,1,Answer
exten => s,n,Set(TIMEOUT(digit)=2)
exten => s,n,Wait(2)
;exten => s,n(record),SetVar(MEETME_RECORDINGFILE=/recording/meetme-conf-rec-${CONFNO}-${UNIQUEID}); 
exten => s,n,Set(MEETME_RECORDINGFORMAT=gsm) 
exten => s,n,MeetMe(|c) 
exten => s,n,Playback(vm-goodbye)
exten => s,n,Hangup

[customer-service]
include => cdxextensions
exten => s,1,Answer
exten => s,n,Ringing
exten => s,n,Wait(1)
exten => s,n,Background(cdx-customer-service)
exten => s,n,Queue(service|w|||15)
exten => s,n,Voicemail(u1389)
exten => s,n,Playback(vm-goodbye)
exten => s,n,Hangup

[reimbursement]
include => cdxextensions
exten => s,1,Answer
exten => s,n,Ringing
exten => s,n,Wait(1)
exten => s,n,Background(cdx-reimb_main)
exten => s,n,Wait(5)
exten => s,n,Background(cdx-reimb_main)
exten => s,n,Wait(5)
exten => s,n,Background(cdx-reimb_main)
exten => s,n,Voicemail(u0973)
exten => s,n,Playback(vm-goodbye)
exten => s,n,Hangup

exten => 1,1,Goto(reimbursement-pt,s,1)
exten => 2,1,Goto(reimbursement-pa,s,1)
exten => 3,1,Goto(reimbursement-ins,s,1)
exten => _[45678],1,Playback(pbx-invalid)
exten => _[45678],2,Goto(reimbursement,s,1)
exten => _[90],1,Goto(reimbursement,s,1)

[reimbursement-pt]
exten => s,1,Background(cdx-reimb_pt)
exten => 1,1,Goto(reimb-low_prio,s,1)
exten => 2,1,Goto(reimb-low_prio,s,1)
exten => 3,1,Goto(reimb-low_prio,s,1)
exten => _[45678],1,Playback(pbx-invalid)
exten => _[45678],2,Goto(reimbursement-pt,s,1)
exten => _[90],1,Goto(reimbursement-pt,s,1)

[reimbursement-pa]
exten => s,1,Goto(reimb-high_prio,s,1)

[reimbursement-ins]
exten => s,1,Background(cdx-reimb_ins)
exten => 1,1,Goto(reimb-low_prio,s,1)
exten => 2,1,Goto(reimb-low_prio,s,1)

[reimb-high_prio]
exten => s,1,Background(transfer)
;exten => s,n,Set(QUEUE_PRIO=10) 
exten => s,n,Queue(reimbursement|rw|||15)
exten => s,n,Voicemail(u0973)
exten => s,n,Playback(vm-goodbye)
exten => s,n,Hangup

[reimb-low_prio]
exten => s,1,Background(transfer)
;exten => s,n,Set(QUEUE_PRIO=5) 
exten => s,n,Queue(reimbursement|rw|||15)
exten => s,n,Voicemail(u0973)
exten => s,n,Playback(vm-goodbye)
exten => s,n,Hangup

[outbound]
exten => _1NXXNXXXXXX,1,Macro(pstntrunk)
exten => _91NXXNXXXXXX,1,Goto(${EXTEN:1},1)
exten => _9NXXXXXX,1,Goto(1650${EXTEN:1},1)
exten => _NXXNXXXXXX,1,Goto(1${EXTEN},1)
exten => _NXXXXXX,1,Goto(1650${EXTEN},1)
exten => _011N.,1,Macro(intltrunk)

exten => 18774752788,1,Goto(conferences,s,1)

exten => 411,1,Directory(default)
;exten => 411,1,Macro(pstntrunk)
;exten => 9411,1,Goto(${EXTEN:1},1)
exten => 911,1,Macro(pstntrunk)
exten => 9911,1,Goto(${EXTEN:1},1)

exten => _81NXXNXXXXXX,1,Macro(nufonetrunk,${EXTEN:1})
exten => _71NXXNXXXXXX,1,Macro(jnctntrunk,${EXTEN:1})

[recordings]
exten => 500,1,Answer
exten => 500,2,Wait(1)
exten => 500,3,Record(myrecording:gsm)
exten => 500,7,Hangup

exten => 501,1,Answer
exten => 501,2,Playback(myrecording)
exten => 501,3,Hangup

exten => 502,1,Answer
exten => 502,n,MusicOnHold()


; agents
exten => 7890,1,Goto(reimbursement,s,1) 	 ; for testing
exten => 0987,1,Goto(customer-service,s,1) ; for testing

; for logging off
exten => 1000,1,Answer
exten => 1000,n,Ringing
exten => 1000,n,Wait(1)
exten => 1000,n,AgentCallbackLogin() 
exten => 1000,n,Hangup

; reimbursement agent login
exten => 1001,1,Answer
exten => 1001,n,Ringing
exten => 1001,n,Wait(1)
exten => 1001,n,AgentCallbackLogin(||${CALLERID(num)}@reimbursement)
exten => 1001,n,Hangup

; customer service agent login
exten => 1002,1,Answer
exten => 1002,n,Ringing
exten => 1002,n,Wait(1)
exten => 1002,n,AgentCallbackLogin(||${CALLERID(num)}@customer-service)
exten => 1002,n,Hangup

; barge on agents
exten => 1999,1,Answer
exten => 1999,2,Ringing
exten => 1999,3,Wait(1)
exten => 1999,4,Authenticate(3577)
exten => 1999,5,ChanSpy(Agent,bq)
exten => 1999,6,Hangup

[give-dialtone]
exten => s,1,Playback(cdx-welcomeshort)
exten => s/6504507477,2,Goto(3)    ; Philip's cell phone number
exten => s,2,Authenticate(2744)
exten => s,3,SetCallerID(${CDXCALLERID:6})   ;; last four digits 
exten => s,4,DISA(no-password|default)

exten => t,1,Playback(vm-goodbye)
exten => t,2,Hangup
exten => i,1,Playback(vm-goodbye)
exten => i,2,Hangup

[pstn]
include => cdxextensions

exten => 2787,1,Answer
exten => 2787,2,Playback(cdx-number-changed)
exten => 2787,3,Wait(2)
exten => 2787,4,Playback(cdx-number-changed)
exten => 2787,5,Wait(2)
exten => 2787,6,Playback(cdx-number-changed)
exten => 2787,7,Hangup

exten => 2788,1,GotoIfTime(9:00-17:00|mon-fri|*|*?2757,1)
exten => 2788,2,Goto(company-directory,s,1)

; Toll free number
; => 1388: 877.475.2788 
exten => 1388,1,Goto(conferences,s,1)
; => 1389: 866.941.4996
exten => 1389,1,Goto(customer-service,s,1) 
; => 0973: 866.941.4995 
exten => 0973,1,Goto(reimbursement,s,1)
; => 0972: 866.941.4998 (spare)


exten => 2799,1,Set(NUMBERCALLED=${EXTEN})
exten => 2799,2,Answer
exten => 2799,3,Ringing
exten => 2799,4,Wait(3)
exten => 2799,5,Congestion

exten => 0919,1,Set(NUMBERCALLED=${EXTEN})
exten => 0919,2,Answer
exten => 0919,3,Ringing
exten => 0919,4,Wait(3)
exten => 0919,5,Congestion


[default]
include => oldextensions
include => cdxextensions
include => outbound
include => recordings

