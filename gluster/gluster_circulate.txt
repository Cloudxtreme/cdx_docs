gluster dht afr mirror

http://www.gluster.org/docs/index.php/Mixing_DHT_and_AFR

--
-- server w/ client-volume-filename
--
volume posix
  type storage/posix
  option directory /home/dht
end-volume

volume brick
  type features/locks
  subvolumes posix
end-volume

volume posix-mirror
  type storage/posix
  option directory /home/dht-mirror
end-volume
 
volume brick-mirror
  type features/locks
  subvolumes posix-mirror
end-volume

volume server
  type protocol/server
  option client-volume-filename /root/glusterfs/glusterfs-cln.vol
  option transport-type tcp
  option auth.addr.brick.allow *
  option auth.addr.brick-mirror.allow *
  subvolumes brick brick-mirror
end-volume

--
-- server w/o client config
--
volume posix
  type storage/posix
  option directory /home/dht
end-volume

volume brick
  type features/locks
  subvolumes posix
end-volume

volume posix-mirror
  type storage/posix
  option directory /home/dht-mirror
end-volume
 
volume brick-mirror
  type features/locks
  subvolumes posix-mirror
end-volume

volume server
  type protocol/server
  option transport-type tcp
  option auth.addr.brick.allow *
  option auth.addr.brick-mirror.allow *
  subvolumes brick brick-mirror
end-volume

--
-- client config (on the gclient1)
--
-- Two servers
--
# more /root/glusterfs/glusterfs-cln.vol
volume remote1
  type protocol/client
  option transport-type tcp
  option remote-host gluster1
  option remote-subvolume brick
end-volume

volume remote2
  type protocol/client
  option transport-type tcp
  option remote-host gluster2
  option remote-subvolume brick
end-volume

volume remote1-mirror
  type protocol/client
  option transport-type tcp
  option remote-host gluster1
  option remote-subvolume brick-mirror
end-volume

volume remote2-mirror
  type protocol/client
  option transport-type tcp
  option remote-host gluster2
  option remote-subvolume brick-mirror
end-volume

volume afr0
  type cluster/afr
  subvolumes remote1 remote2-mirror
end-volume

volume afr1
  type cluster/afr
  subvolumes remote2 remote1-mirror
end-volume

volume hash
  type cluster/dht
  subvolumes afr0 afr1
end-volume


--
-- client
--
glusterfs --volfile-server gluster1 /mnt/glusterfs/

touch ./hello{0,1,2,3,4,5,6,7,8}

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

--
-- adding a new server
--
r1, r2m --> afr0
r2, r3m --> afr1
r3, r1m --> afr2

Need to restart glusterfs????

Somehow the hash table still remember the original nodes.  It will not add data to 
the newly added node.  (Will add the mirrored data, though.)



